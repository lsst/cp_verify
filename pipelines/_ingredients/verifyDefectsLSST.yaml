description: cp_verify for Defects measured from combined calibrations (LSST ISR task).
imports:
  - location: $ANALYSIS_TOOLS_DIR/pipelines/cpCore.yaml
    include:
      - analyzeDefectCore
tasks:
  verifyDefectsIsr:
    class: lsst.ip.isr.IsrTaskLSST
    config:
      connections.ccdExposure: "raw"
      connections.outputExposure: "verifyDefectsIsrExp"
      python: |
        from lsst.cp.pipe import configureIsrTaskLSSTForCalibrations

        configureIsrTaskLSSTForCalibrations(config)

        config.doCrosstalk = True
        config.crosstalk.doQuadraticCrosstalkCorrection = True
        config.doApplyGains = True
        config.doLinearize = True
        # TODO DM-46426: Add cpCtiLSST pipeline so that this can be True.
        config.doDeferredCharge = False
        config.doBias = True
        config.doDark = True
        config.doDefect = True
        config.doBrighterFatter = True
        config.doFlat = True
        config.isrStats.doCopyCalibDistributionStatistics = True
  verifyUncorrectedDefectsIsr:
    class: lsst.ip.isr.IsrTaskLSST
    config:
      connections.ccdExposure: "raw"
      connections.outputExposure: "verifyUncorrectedDefectsIsrExp"
      python: |
        from lsst.cp.pipe import configureIsrTaskLSSTForCalibrations

        configureIsrTaskLSSTForCalibrations(config)

        config.doCrosstalk = True
        config.crosstalk.doQuadraticCrosstalkCorrection = True
        config.doApplyGains = True
        config.doLinearize = True
        # TODO DM-46426: Add cpCtiLSST pipeline so that this can be True.
        config.doDeferredCharge = False
        config.doBias = True
        config.doDark = True
        # This is False for the uncorrected defects.
        config.doDefect = False
        config.doBrighterFatter = True
        config.doFlat = True
        config.doCalculateStatistics = False
        config.isrStats.doCopyCalibDistributionStatistics = True
  verifyDefectsDet:
    class: lsst.cp.verify.CpVerifyDefectsTask
    config:
      connections.inputExp: "verifyDefectsIsrExp"
      connections.uncorrectedExp: "verifyUncorrectedDefectsIsrExp"
      connections.outputStats: "verifyDefectsDetStats"
      connections.outputResults: "verifyDefectsDetResults"
      useIsrStatistics: true
      hasMatrixCatalog: false
      catalogStatKeywords: ""
  verifyDefectsExp:
    class: lsst.cp.verify.CpVerifyVisitExpMergeTask
    config:
      connections.inputStats: "verifyDefectsDetStats"
      connections.inputResults: "verifyDefectsDetResults"
      connections.outputStats: "verifyDefectsExpStats"
      connections.outputResults: "verifyDefectsExpResults"
      mergeDimension: "exposure"
      hasInputResults: true
      hasMatrixCatalog: false
  verifyDefects:
    class: lsst.cp.verify.CpVerifyVisitRunMergeTask
    config:
      connections.inputStats: "verifyDefectsExpStats"
      connections.inputResults: "verifyDefectsExpResults"
      connections.outputStats: "verifyDefectsStats"
      connections.outputResults: "verifyDefectsResults"
      mergeDimension: "visit"
      hasInputResults: true
      hasMatrixCatalog: false
contracts:
  - verifyDefectsExp.connections.inputStats == verifyDefectsDet.connections.outputStats
  - verifyDefectsExp.connections.inputResults == verifyDefectsDet.connections.outputResults
