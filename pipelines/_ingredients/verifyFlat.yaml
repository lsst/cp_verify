description: cp_verify FLAT calibration verification
imports:
  - location: $ANALYSIS_TOOLS_DIR/pipelines/cpCore.yaml
    include:
      - analyzeFlatCore
      - analyzeFlatDetMergeCore
tasks:
  verifyFlatIsr:
    class: lsst.ip.isr.IsrTask
    config:
      connections.ccdExposure: "raw"
      connections.outputExposure: "verifyFlatIsrExp"
      # Disable downstream processing.
      doApplyGains: false
      doFringe: false
      doCalculateStatistics: true
      isrStats.doCopyCalibDistributionStatistics: true
  verifyFlatDetMerge:
    class: lsst.cp.verify.CpVerifyDetMergeByFilterTask
    config:
      connections.inputStats: "verifyFlatDetStats"
      connections.inputResults: "verifyFlatDetResults"
      connections.outputStats: "verifyFlatDetMergeStats"
      connections.outputResults: "verifyFlatDetMergeResults"
      hasInputResults: true
      hasMatrixCatalog: false
      stageName: "flat"
  verifyFlatDet:
    class: lsst.cp.verify.CpVerifyFlatTask
    config:
      connections.inputExp: "verifyFlatIsrExp"
      connections.outputStats: "verifyFlatDetStats"
      connections.outputResults: "verifyFlatDetResults"
      useIsrStatistics: true
  verifyFlatExp:
    class: lsst.cp.verify.CpVerifyFlatExpMergeTask
    config:
      connections.inputStats: "verifyFlatDetStats"
      connections.inputResults: "verifyFlatDetResults"
      connections.outputStats: "verifyFlatExpStats"
      connections.outputResults: "verifyFlatExpResults"
      hasInputResults: true
      hasMatrixCatalog: false
      stageName: "flat"
  analyzeFlatCore:
    class: lsst.analysis.tools.tasks.VerifyCalibAnalysisTaskByFilter
    config:
      connections.data: "verifyFlatResults"
      connections.outputName: "verifyFlatAnalysis"
  analyzeFlatDetMergeCore:
    class: lsst.analysis.tools.tasks.VerifyCalibAnalysisTaskByFilter
    config:
      connections.data: "verifyFlatDetMergeResults"
      connections.outputName: "verifyFlatDetMergeAnalysis"
  verifyFlat:
    class: lsst.cp.verify.CpVerifyRunMergeByFilterTask
    config:
      connections.inputStats: "verifyFlatExpStats"
      connections.inputResults: "verifyFlatExpResults"
      connections.outputStats: "verifyFlatStats"
      connections.outputResults: "verifyFlatResults"
      hasInputResults: true
      hasMatrixCatalog: false
contracts:
  - verifyFlatDet.connections.inputExp == verifyFlatIsr.connections.outputExposure
  - verifyFlatExp.connections.inputStats == verifyFlatDet.connections.outputStats
  - verifyFlatExp.connections.inputResults == verifyFlatDet.connections.outputResults
  - verifyFlat.connections.inputStats == verifyFlatExp.connections.outputStats
  - verifyFlat.connections.inputResults == verifyFlatExp.connections.outputResults
  - analyzeFlatCore.connections.data == verifyFlat.connections.outputResults
  - analyzeFlatDetMergeCore.connections.data == verifyFlatDetMerge.connections.outputResults
